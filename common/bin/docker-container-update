#!/bin/bash

echo "Checking for Docker container updates..."
for d in ~/docker/*/; do
  compose=${d}docker-compose.yml
  
  if [ -f "$compose" ]; then
    cd $d
    
    readarray -t image_names < <(grep -o "image: .*" docker-compose.yml | sed 's|image: ||')
    for image_name in ${image_names[@]}; do
      no_tag=$(echo ${image_name} | cut -d ":" -f1)
      old_id=$(docker compose images | grep ${no_tag} | awk '{ print $4 }')

      echo
      echo "Checking for updates for ${image_name}..."
      docker compose pull -q

      new_id=$(docker images ${image_name} | sed -n 2p | awk '{ print $3 }')

      if [ "$old_id" != "$new_id" ]; then
        echo "Updating ${image_name}..."
        sops exec-env ~/secrets.env 'docker compose up -d --force-recreate'
        echo "Updated ${image_name}"
      else
        echo "${image_name} is up to date."
      fi
    done
  fi
done

read -p "Cleanup Docker? (docker system prune -a --volumes -f) [Y/n] " -n 1 -r reply
echo
[[ ! ${reply} =~ ^[Nn]$ ]] && docker system prune -a --volumes -f
